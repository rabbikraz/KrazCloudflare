'use client'

import React, { useState, useEffect, useRef } from 'react'
import { ChevronDown, ChevronUp, Maximize2, X, ZoomIn, ZoomOut, ExternalLink } from 'lucide-react'

// --- üõ†Ô∏è 1. PASTE YOUR DATA HERE üõ†Ô∏è ---
const SHIUR_DATA = {
    title: "Mummies",
    date: "January 5, 2026",
    duration: "45 min",
    // Paste the Description below
    description: "Explore the fascinating history and halachic questions surrounding Mummies in this deep-dive shiur.",
    
    // Paste Audio & Source Links
    audioUrl: "https://your-audio-url.com/mummies.mp3",
    sourceDoc: "https://your-pdf-url.com/mummies.pdf", // If PDF exists
    
    // Paste Platform Links (or leave null/empty string to hide)
    platformLinks: {
        youtube: "https://youtu.be/...",
        spotify: "https://open.spotify.com/...",
        apple: "https://podcasts.apple.com/...",
        amazon: "",
        pocket: ""
    },

    // üìã PASTE CLIPPED SOURCES JSON HERE if available
    // Example: [{id: "1", name: "Source 1", image: "...", ...}]
    sourcesJson: null 
}


// --- üöÄ MAIN COMPONENT ---
export default function MummiesPage() {
    return (
        <div className="min-h-screen flex flex-col bg-slate-50 font-sans text-slate-900 selection:bg-blue-100">
            {/* Header (No Links) */}
            <header className="bg-slate-900 text-white py-4 shadow-md z-10">
                <div className="max-w-5xl mx-auto px-4 flex items-center justify-center md:justify-start">
                    <div className="font-serif text-xl md:text-2xl font-bold tracking-tight text-center md:text-left">
                        Rabbi Kraz's Shiurim
                    </div>
                </div>
            </header>

            <main className="flex-1 w-full max-w-5xl mx-auto px-4 py-8 md:py-12 pb-20">
                
                {/* Title Section */}
                <div className="mb-10 text-center md:text-left">
                    <h1 className="font-serif text-4xl md:text-5xl font-black text-slate-900 mb-4 leading-tight tracking-tight">
                        {SHIUR_DATA.title}
                    </h1>
                    <div className="flex flex-wrap items-center justify-center md:justify-start gap-4 text-sm font-bold text-slate-500 uppercase tracking-widest">
                        <span>{SHIUR_DATA.date}</span>
                        {SHIUR_DATA.duration && (
                            <>
                                <span className="w-1.5 h-1.5 bg-slate-300 rounded-full"></span>
                                <span>{SHIUR_DATA.duration}</span>
                            </>
                        )}
                    </div>
                </div>

                {/* Platform Links */}
                <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 md:p-8 mb-8">
                    <h2 className="font-serif text-lg font-bold text-slate-900 mb-6 text-center">
                        Listen on Your Favorite Platform
                    </h2>
                    <div className="flex flex-wrap justify-center gap-6 md:gap-10">
                        <PlatformButton 
                            href={SHIUR_DATA.platformLinks.youtube} label="YouTube" color="#FF0000"
                            icon={<svg viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>}
                        />
                        <PlatformButton 
                            href={SHIUR_DATA.platformLinks.spotify} label="Spotify" color="#1DB954"
                            icon={<svg viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12cs6.6 0 12-5.4 12-12S18.6 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>}
                        />
                         <PlatformButton 
                            href={SHIUR_DATA.platformLinks.apple} label="Apple" color="#000000"
                            icon={<svg viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.26-.35C2.92 16.59 1.69 11.4 4.79 9.37c1.55-1.02 2.82-.95 3.82-.24.69.49 1.62.64 2.12.64.63 0 1.76-.23 2.76-.71 1.15-.56 2.45-.66 3.49-.07 1.02.58 1.83 1.51 2.29 2.49-3.79 1.6-3.14 6.7.53 8.01-.1.52-.36 1.33-.75 1.79zm-3.13-14.36c-1.67-.13-2.92 1.4-3.1 2.91 1.64.24 3.12-1.47 3.1-2.91z"/></svg>}
                        />
                    </div>
                </div>

                {/* Description */}
                {SHIUR_DATA.description && (
                    <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 md:p-10 mb-8">
                        <p className="text-lg md:text-xl text-slate-700 leading-relaxed font-serif">
                            {SHIUR_DATA.description}
                        </p>
                    </div>
                )}

                {/* Source Sheet Viewer (Standalone Embedded) */}
                <StandaloneSourceViewer 
                    sourceDoc={SHIUR_DATA.sourceDoc}
                    sourcesJson={SHIUR_DATA.sourcesJson}
                    title={SHIUR_DATA.title}
                />
            </main>
        </div>
    )
}

// Helper: Platform Button
function PlatformButton({ href, label, icon, color }: any) {
    if (!href) return null
    return (
        <a href={href} target="_blank" rel="noopener noreferrer" className="group flex flex-col items-center gap-3 no-underline">
            <div 
                className="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center text-white shadow-lg transition-transform transform group-hover:-translate-y-1 group-hover:shadow-xl group-hover:scale-110"
                style={{ backgroundColor: color }}
            >
                {icon}
            </div>
            <span className="text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest group-hover:text-slate-900 transition-colors">{label}</span>
        </a>
    )
}

// ----------------------------------------------------------------------------------
// üß© STANDALONE VIEWER COMPONENTS (Zoom/Pan Physics Included)
// ----------------------------------------------------------------------------------

function StandaloneSourceViewer({ sourceDoc, sourcesJson, title }: { sourceDoc?: string | null, sourcesJson?: any, title?: string }) {
    const [allSources, setAllSources] = useState<any[]>([])
    const [expandedSources, setExpandedSources] = useState<Set<string>>(new Set())
    const [showPdf, setShowPdf] = useState(false)
    const [embedUrl, setEmbedUrl] = useState<string | null>(null)
    const [previewSource, setPreviewSource] = useState<any | null>(null)

    // Load Data
    useEffect(() => {
        if (sourcesJson) {
            try {
                let parsed = typeof sourcesJson === 'string' ? JSON.parse(sourcesJson) : sourcesJson
                if (Array.isArray(parsed)) {
                    setAllSources(parsed)
                    setExpandedSources(new Set()) 
                }
            } catch (e) { console.error("Error parsing sources", e) }
        }
    }, [sourcesJson])

    useEffect(() => {
        if (sourceDoc) {
            let url = sourceDoc
            // Fix dropbox/drive links for embedding
            if (url.includes('dropbox.com')) url = url.replace('?dl=0', '').replace('?dl=1', '') + '?raw=1'
            else if (url.includes('drive.google.com') && url.includes('/view')) url = url.replace('/view', '/preview')
            setEmbedUrl(url)
        }
    }, [sourceDoc])

    // Default View Logic
    const hasAnySources = allSources.length > 0
    useEffect(() => {
        if (!hasAnySources && sourceDoc) setShowPdf(true)
    }, [hasAnySources, sourceDoc])

    const toggleSource = (id: string) => {
        const newSet = new Set(expandedSources)
        if (newSet.has(id)) newSet.delete(id)
        else newSet.add(id)
        setExpandedSources(newSet)
    }

    if (!hasAnySources && !sourceDoc) return null;

    return (
        <div className="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
             {/* Viewer Header */}
             <div className="bg-white px-6 py-5 flex flex-wrap items-center justify-between gap-4 border-b border-gray-100">
                <div className="flex items-center gap-3">
                    <span className="text-2xl">üìú</span>
                    <h2 className="text-xl font-serif font-bold text-slate-800">Source Sheet</h2>
                </div>
                
                <div className="flex items-center gap-4">
                    {/* View Toggle */}
                    {hasAnySources && sourceDoc && (
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setShowPdf(false)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${!showPdf ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>Clipped</button>
                            <button onClick={() => setShowPdf(true)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${showPdf ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>PDF</button>
                        </div>
                    )}
                    {sourceDoc && (
                        <a href={sourceDoc} target="_blank" rel="noopener noreferrer" className="bg-slate-50 hover:bg-slate-100 text-slate-400 hover:text-blue-600 p-2 rounded-lg transition-colors" title="Open Original PDF">
                            <ExternalLink size={20} />
                        </a>
                    )}
                </div>
            </div>

            {/* Content Body */}
            <div>
                 {/* MODE: SOURCES LIST */}
                 {(!showPdf || !sourceDoc) && hasAnySources && (
                    <div className="divide-y divide-slate-50">
                        {allSources.map((source, idx) => {
                            const isExpanded = expandedSources.has(source.id)
                            return (
                                <div key={source.id} className="bg-white group">
                                    <button 
                                        onClick={() => toggleSource(source.id)}
                                        className="w-full flex items-start text-left gap-5 px-6 py-6 hover:bg-slate-50/80 transition-colors"
                                    >
                                        <span className={`flex-shrink-0 w-8 h-8 flex items-center justify-center text-sm font-bold rounded-full transition-colors ${isExpanded ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400 group-hover:bg-blue-100 group-hover:text-blue-600'}`}>
                                            {idx + 1}
                                        </span>
                                        <div className="flex-1 pt-1">
                                            <span className={`font-serif text-lg leading-snug transition-colors ${isExpanded ? 'text-blue-900 font-bold' : 'text-slate-700 font-medium'}`}>{source.name}</span>
                                        </div>
                                        <div className="pt-1">
                                             {isExpanded ? <ChevronUp className="text-blue-500" /> : <ChevronDown className="text-slate-300 group-hover:text-blue-400" />}
                                        </div>
                                    </button>
                                    
                                    {isExpanded && source.image && (
                                        <div className="px-6 pb-10 pl-[4.5rem] animate-in slide-in-from-top-2 duration-200">
                                            <div 
                                                className="relative rounded-xl overflow-hidden border border-slate-200 shadow-sm cursor-zoom-in group/image bg-slate-50"
                                                onClick={() => setPreviewSource(source)}
                                            >
                                                <img src={source.image} alt={source.name} className="w-full block" loading="lazy" />
                                                <div className="absolute top-4 right-4 opacity-0 group-hover/image:opacity-100 transition-opacity bg-black/70 text-white px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-2 backdrop-blur-md shadow-lg transform translate-y-2 group-hover/image:translate-y-0 duration-200">
                                                    <Maximize2 size={14} /> Tap to Expand
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )
                        })}
                    </div>
                 )}

                 {/* MODE: PDF EMBED */}
                 {(showPdf || (!hasAnySources && sourceDoc)) && embedUrl && (
                    <div className="h-[800px] w-full bg-slate-100 relative">
                        <iframe src={embedUrl} className="w-full h-full border-0" title={`Source Sheet: ${title}`} loading="lazy" allowFullScreen />
                    </div>
                 )}
            </div>

            {/* LIGHTBOX (ZoomPan) */}
            {previewSource && (
                <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex flex-col animate-in fade-in duration-300">
                    <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-50 pointer-events-none">
                        <span className="text-white/90 font-bold px-4 text-shadow-sm truncate max-w-[80%]">{previewSource.name}</span>
                        <button 
                            onClick={() => setPreviewSource(null)} 
                            className="pointer-events-auto bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md cursor-pointer transition-colors border border-white/10"
                        >
                            <X size={24} />
                        </button>
                    </div>
                    
                    <div className="absolute inset-0 z-0">
                         <ZoomPanContainer src={previewSource.image} alt={previewSource.name} onClose={() => setPreviewSource(null)} />
                    </div>
                </div>
            )}
        </div>
    )
}

// --- PHYSICS ZOOM ENGINE ---
function ZoomPanContainer({ src, alt, onClose }: { src: string; alt: string; onClose: () => void }) {
    const containerRef = useRef<HTMLDivElement>(null)
    const [transform, setTransform] = useState({ x: 0, y: 0, scale: 1 })
    const [isDragging, setIsDragging] = useState(false)
    const [hasMoved, setHasMoved] = useState(false)
    const lastMouse = useRef({ x: 0, y: 0 })
    const lastTouchDistance = useRef<number | null>(null)

    const updateTransform = (x: number, y: number, scale: number) => {
        setTransform({ x, y, scale: Math.min(Math.max(0.5, scale), 8) })
    }

    // Mouse Wheel (Precise Zoom)
    const handleWheel = (e: React.WheelEvent) => {
        e.preventDefault(); e.stopPropagation()
        const rect = containerRef.current?.getBoundingClientRect()
        if (!rect) return
        const delta = -e.deltaY
        const factor = delta > 0 ? 1.1 : 0.9
        const newScale = Math.min(Math.max(0.5, transform.scale * factor), 8)
        
        const offsetX = e.clientX - rect.left - rect.width / 2
        const offsetY = e.clientY - rect.top - rect.height / 2
        const newX = offsetX - (offsetX - transform.x) * (newScale / transform.scale)
        const newY = offsetY - (offsetY - transform.y) * (newScale / transform.scale)
        updateTransform(newX, newY, newScale)
    }

    // Pan (Drag)
    const handleMouseDown = (e: React.MouseEvent) => {
        e.preventDefault(); e.stopPropagation()
        setIsDragging(true); setHasMoved(false)
        lastMouse.current = { x: e.clientX, y: e.clientY }
    }
    const handleMouseMove = (e: React.MouseEvent) => {
        if (!isDragging) return
        e.preventDefault(); e.stopPropagation()
        const dx = e.clientX - lastMouse.current.x
        const dy = e.clientY - lastMouse.current.y
        if (Math.abs(dx) > 1 || Math.abs(dy) > 1) setHasMoved(true)
        lastMouse.current = { x: e.clientX, y: e.clientY }
        updateTransform(transform.x + dx, transform.y + dy, transform.scale)
    }
    const handleMouseUp = () => setIsDragging(false)
    
    // Smart Close (Tap Background)
    const handleClick = (e: React.MouseEvent) => {
        e.stopPropagation()
        if (hasMoved) return
        if (!(e.target instanceof HTMLImageElement)) onClose()
    }

    // Double Click Zoom
    const handleDoubleClick = (e: React.MouseEvent) => {
        e.stopPropagation()
        if (transform.scale > 1.1) setTransform({ x: 0, y: 0, scale: 1 })
        else setTransform({ x: 0, y: 0, scale: 2.5 })
    }

    // Touch (Pinch)
    const getDist = (t1: React.Touch, t2: React.Touch) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY)
    const handleTouchStart = (e: React.TouchEvent) => {
        e.stopPropagation(); setHasMoved(false)
        if (e.touches.length === 2) lastTouchDistance.current = getDist(e.touches[0], e.touches[1])
        else if (e.touches.length === 1) { setIsDragging(true); lastMouse.current = {x: e.touches[0].clientX, y: e.touches[0].clientY} }
    }
    const handleTouchMove = (e: React.TouchEvent) => {
        e.stopPropagation(); setHasMoved(true)
        if (e.touches.length === 2 && lastTouchDistance.current) {
            const dist = getDist(e.touches[0], e.touches[1])
            const factor = dist / lastTouchDistance.current
            updateTransform(transform.x, transform.y, transform.scale * factor)
            lastTouchDistance.current = dist
        } else if (e.touches.length === 1 && isDragging) {
            const dx = e.touches[0].clientX - lastMouse.current.x
            const dy = e.touches[0].clientY - lastMouse.current.y
            lastMouse.current = {x: e.touches[0].clientX, y: e.touches[0].clientY}
            updateTransform(transform.x + dx, transform.y + dy, transform.scale)
        }
    }
    const handleTouchEnd = () => { setIsDragging(false); lastTouchDistance.current = null }

    return (
        <div 
            ref={containerRef}
            className="w-full h-full flex items-center justify-center overflow-hidden cursor-grab active:cursor-grabbing touch-none select-none"
            onWheel={handleWheel}
            onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}
            onClick={handleClick} onDoubleClick={handleDoubleClick}
            onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
        >
            <img 
                src={src} alt={alt} draggable={false}
                style={{ transform: `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`, transition: isDragging ? 'none' : 'transform 0.1s ease-out', willChange: 'transform' }}
                className="max-w-[95vw] max-h-[90vh] object-contain shadow-2xl block touch-none pointer-events-auto" 
            />
            {/* Overlay Controls */}
            <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-4 z-50 pointer-events-auto">
                 <button
                    onClick={(e) => { e.stopPropagation(); transform.scale > 1.1 ? setTransform({x:0,y:0,scale:1}) : setTransform({x:0,y:0,scale:2.5}) }}
                    className="bg-white/10 hover:bg-white/20 backdrop-blur-md text-white px-5 py-3 rounded-full flex items-center gap-2 text-sm font-bold shadow-xl border border-white/20 transition-all hover:scale-105"
                >
                    {transform.scale > 1.1 ? <ZoomOut size={18} /> : <ZoomIn size={18} />}
                    {transform.scale > 1.1 ? 'Reset View' : 'Zoom In'}
                </button>
            </div>
        </div>
    )
}
